{"version":3,"file":"PWAInstall.js","sources":["../../../src/client/components/PWAInstallModal.ts","../../../src/client/components/PWAInstall.ts"],"sourcesContent":["import { withBase } from \"@vuepress/client\";\nimport { useEventListener } from \"@vueuse/core\";\nimport { type VNode, defineComponent, h, onMounted, ref } from \"vue\";\nimport { useLocaleConfig } from \"vuepress-shared/client\";\n\nimport { ArrowLeftIcon, ArrowRightIcon, CloseIcon } from \"./icons.js\";\nimport { type ManifestOption } from \"../../shared/index.js\";\nimport { locales } from \"../define.js\";\n\ninterface InstallPromptEvent extends Event {\n  readonly platforms: string;\n  prompt: () => void;\n  readonly userChoice: Promise<{ outcome: \"accepted\" | \"dismissed\" }>;\n}\n\nexport default defineComponent({\n  name: \"PWAInstallModal\",\n\n  props: {\n    /**\n     * Whether use hint message instead of showing a button\n     *\n     * 是否使用提示\n     */\n    useHint: Boolean,\n  },\n\n  emits: [\"canInstall\", \"hint\", \"close\"],\n\n  setup(props, { emit }) {\n    const locale = useLocaleConfig(locales);\n\n    const manifest = ref<ManifestOption>({});\n    const deferredPrompt = ref<InstallPromptEvent>();\n\n    const getManifest = async (): Promise<void> => {\n      const manifestContent = localStorage.getItem(\"manifest\");\n\n      if (manifestContent)\n        manifest.value = <ManifestOption>JSON.parse(manifestContent);\n      else\n        try {\n          const response = await fetch(withBase(\"manifest.webmanifest\"));\n          const data = <ManifestOption>await response.json();\n\n          manifest.value = data;\n          localStorage.setItem(\"manifest\", JSON.stringify(data));\n        } catch (err) {\n          console.error(\n            \"[PWA]: Error getting manifest, check that you have a valid web manifest or network connection\"\n          );\n        }\n    };\n\n    const scrollToLeft = (): void => {\n      const screenshotsDiv = document.querySelector(\".screenshot\");\n\n      if (screenshotsDiv)\n        screenshotsDiv.scrollBy({\n          left: -screenshotsDiv.clientWidth,\n          top: 0,\n          behavior: \"smooth\",\n        });\n    };\n\n    const scrollToRight = (): void => {\n      const screenshotsDiv = document.querySelector(\".screenshot\");\n\n      if (screenshotsDiv)\n        screenshotsDiv.scrollBy({\n          left: screenshotsDiv.clientWidth,\n          top: 0,\n          behavior: \"smooth\",\n        });\n    };\n\n    const install = async (): Promise<void> => {\n      if (deferredPrompt.value) {\n        deferredPrompt.value.prompt();\n\n        document.dispatchEvent(new CustomEvent(\"show\"));\n\n        const choiceResult = await deferredPrompt.value.userChoice;\n\n        if (choiceResult.outcome === \"accepted\") {\n          console.info(\"PWA has been installed\");\n\n          emit(\"close\", false);\n          emit(\"canInstall\", false);\n        } else {\n          console.info(\"You choose to not install PWA\");\n\n          emit(\"close\", false);\n          emit(\"canInstall\", false);\n        }\n      }\n    };\n\n    const hint = (): void => {\n      console.info(\"You accepted the install hint\");\n      emit(\"hint\");\n    };\n\n    onMounted(() => {\n      // eslint-disable-next-line no-prototype-builtins\n      if (window.hasOwnProperty(\"BeforeInstallPromptEvent\")) {\n        useEventListener(window, \"beforeinstallprompt\", (event) => {\n          deferredPrompt.value = <InstallPromptEvent>event;\n\n          emit(\"canInstall\", true);\n          event.preventDefault();\n        });\n\n        useEventListener(\"keyup\", (event): void => {\n          if (event.key === \"Escape\") emit(\"close\", false);\n        });\n\n        void getManifest();\n      }\n    });\n\n    return (): VNode =>\n      h(\"div\", { id: \"install-modal-wrapper\" }, [\n        h(\"div\", { class: \"background\", onClick: () => emit(\"close\", false) }),\n\n        h(\"div\", { class: \"install-modal\" }, [\n          h(\"div\", { class: \"header\" }, [\n            // close button\n            h(\n              \"button\",\n              {\n                type: \"button\",\n                class: \"close-button\",\n                \"aria-label\": locale.value.close,\n                onClick: () => emit(\"close\", false),\n              },\n              h(CloseIcon)\n            ),\n\n            h(\"div\", { class: \"logo\" }, [\n              manifest.value.icons\n                ? h(\"img\", {\n                    src: manifest.value.icons[0]?.src,\n                    alt: \"App Logo\",\n                  })\n                : null,\n              h(\"div\", { class: \"title\" }, [\n                h(\"h1\", manifest.value.short_name || manifest.value.name),\n                h(\"p\", { class: \"desc\" }, locale.value.explain),\n              ]),\n            ]),\n          ]),\n\n          h(\"div\", { class: \"content\" }, [\n            h(\"div\", { class: \"highlight\" }, [\n              manifest.value.features\n                ? h(\"div\", { class: \"feature-wrapper\" }, [\n                    h(\"h3\", locale.value.feature),\n                    h(\n                      \"ul\",\n                      manifest.value.features.map((feature) => h(\"li\", feature))\n                    ),\n                  ])\n                : null,\n\n              manifest.value.screenshots\n                ? h(\"div\", { class: \"screenshot-wrapper\" }, [\n                    h(\n                      \"button\",\n                      {\n                        type: \"button\",\n                        \"aria-label\": locale.value.prevImage,\n                        onClick: scrollToLeft,\n                      },\n                      h(ArrowLeftIcon)\n                    ),\n                    h(\"section\", { class: \"screenshot\" }, [\n                      manifest.value.screenshots.map((screenshot) =>\n                        h(\n                          \"div\",\n                          h(\"img\", {\n                            src: screenshot.src,\n                            alt: \"App Screenshot\",\n                          })\n                        )\n                      ),\n                    ]),\n                    h(\n                      \"button\",\n                      {\n                        type: \"button\",\n                        \"aria-label\": locale.value.nextImage,\n                        onClick: scrollToRight,\n                      },\n                      h(ArrowRightIcon)\n                    ),\n                  ])\n                : null,\n            ]),\n\n            h(\"div\", { class: \"description\" }, [\n              h(\"h3\", locale.value.desc),\n              h(\"p\", manifest.value.description),\n            ]),\n          ]),\n\n          props.useHint\n            ? h(\"div\", { class: \"ios-text\", onClick: hint }, [\n                h(\"p\", locale.value.iOSInstall),\n                h(\"button\", { type: \"button\", class: \"success\" }, \"Got it!\"),\n              ])\n            : h(\"div\", { class: \"button-wrapper\" }, [\n                h(\n                  \"button\",\n                  { type: \"button\", class: \"install-button\", onClick: install },\n                  [locale.value.install, h(\"span\", manifest.value.short_name)]\n                ),\n                h(\n                  \"button\",\n                  {\n                    type: \"button\",\n                    class: \"cancel-button\",\n                    onClick: () => emit(\"close\", false),\n                  },\n                  locale.value.cancel\n                ),\n              ]),\n        ]),\n      ]);\n  },\n});\n","import { useToggle } from \"@vueuse/core\";\nimport { type VNode, computed, defineComponent, h, onMounted, ref } from \"vue\";\nimport { useLocaleConfig } from \"vuepress-shared/client\";\n\nimport PWAInstallModal from \"./PWAInstallModal.js\";\nimport { type ManifestExternalApplicationResource } from \"../../shared/index.js\";\nimport { locales } from \"../define.js\";\n\nimport \"../styles/modal.scss\";\n\ninterface ModernNavigator extends Navigator {\n  // Nonstandard Api\n  getInstalledRelatedApps: () => Promise<ManifestExternalApplicationResource[]>;\n}\n\ninterface SafariNavigator extends Navigator {\n  // Available on Apple’s iOS Safari only.\n  standalone: boolean;\n}\n\nexport default defineComponent({\n  name: \"PWAInstall\",\n\n  setup() {\n    const locale = useLocaleConfig(locales);\n    const [isOpen, toggleIsOpen] = useToggle(false);\n\n    const canInstall = ref(false);\n    const hasRelatedApps = ref(false);\n    const isIOS = ref(false);\n    const isSafari = ref(false);\n    const hinted = ref(false);\n\n    const useHint = computed(\n      () => isIOS.value && isSafari.value && hinted.value === false\n    );\n\n    const showInstall = computed(\n      () => (hasRelatedApps.value && canInstall.value) || useHint.value\n    );\n\n    const getInstalledStatus = (): boolean => {\n      if ((navigator as SafariNavigator).standalone)\n        return (navigator as SafariNavigator).standalone;\n\n      return matchMedia(\"(display-mode: standalone)\").matches;\n    };\n\n    const hint = (): void => {\n      toggleIsOpen(false);\n      hinted.value = true;\n      // do not notify again\n      localStorage.setItem(\"iOS-pwa-hint\", \"hinted\");\n    };\n\n    onMounted(() => {\n      if (getInstalledStatus()) {\n        const { userAgent } = navigator;\n\n        // handle iOS specifically\n        isIOS.value =\n          // regular iPhone\n          userAgent.includes(\"iPhone\") ||\n          // regular iPad\n          userAgent.includes(\"iPad\") ||\n          // iPad pro\n          Boolean(\n            userAgent.includes(\"Macintosh\") &&\n              navigator.maxTouchPoints &&\n              navigator.maxTouchPoints > 2\n          );\n\n        isSafari.value =\n          navigator.userAgent.includes(\"Safari\") &&\n          !userAgent.includes(\"Chrome\");\n\n        hinted.value = Boolean(localStorage.getItem(\"iOS-pwa-hint\"));\n      }\n\n      if (\"getInstalledRelatedApps\" in (navigator as ModernNavigator))\n        void (navigator as ModernNavigator)\n          .getInstalledRelatedApps()\n          .then((result) => {\n            hasRelatedApps.value = result.length > 0;\n          });\n    });\n\n    return (): VNode =>\n      h(\"div\", { id: \"pwa-install\" }, [\n        showInstall.value\n          ? h(\n              \"button\",\n              {\n                type: \"button\",\n                class: \"modal-button\",\n                onClick: () => {\n                  toggleIsOpen(true);\n                },\n              },\n              locale.value.install\n            )\n          : null,\n        h(PWAInstallModal, {\n          style: {\n            display: isOpen.value ? \"block\" : \"none\",\n          },\n          useHint: useHint.value,\n          onCanInstall: (value: boolean) => {\n            canInstall.value = value;\n          },\n          onHint: () => hint(),\n          onClose: () => toggleIsOpen(false),\n        }),\n      ]);\n  },\n});\n"],"names":["defineComponent","props","emit","locale","useLocaleConfig","locales","manifest","ref","deferredPrompt","getManifest","manifestContent","data","withBase","scrollToLeft","screenshotsDiv","scrollToRight","install","hint","onMounted","useEventListener","event","_a","h","CloseIcon","feature","ArrowLeftIcon","screenshot","ArrowRightIcon","isOpen","toggleIsOpen","useToggle","canInstall","hasRelatedApps","isIOS","isSafari","hinted","useHint","computed","showInstall","getInstalledStatus","userAgent","result","PWAInstallModal","value"],"mappings":"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"}